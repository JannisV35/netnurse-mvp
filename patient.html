<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetNurse - Meine Betreuung</title>
<style>
  * {box-sizing: border-box; margin: 0; padding: 0;}
  body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0;}
  
  /* Header */
  .app-header {background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;}
  .app-header h1 {font-size: 1.3em; color: #333;}
  .user-info {display: flex; align-items: center; gap: 10px;}
  .user-avatar {width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;}
  
  /* Container */
  .container {max-width: 600px; margin: 0 auto; padding: 20px;}
  
  /* Welcome Screen */
  .welcome-screen {text-align: center; color: white; padding: 40px 20px; display: block;}
  .welcome-screen h2 {font-size: 2em; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.2);}
  .welcome-screen p {font-size: 1.1em; opacity: 0.9; margin-bottom: 40px;}
  
  /* Main Buttons */
  .main-buttons {display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;}
  .main-btn {background: white; border: none; border-radius: 20px; padding: 40px 20px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: all 0.3s; text-decoration: none; color: #333; display: flex; flex-direction: column; align-items: center; gap: 15px; position: relative;}
  .main-btn:hover {transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.3);}
  .main-btn-icon {font-size: 3.5em;}
  .main-btn-text {font-size: 1.2em; font-weight: 600;}
  .main-btn-desc {font-size: 0.85em; color: #666; margin-top: 5px;}
  
  /* Content Screens */
  .content-screen {display: none;}
  .content-screen.active {display: block;}
  
  .back-btn {background: white; border: none; border-radius: 12px; padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1em; font-weight: 600; color: #667eea; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.2s;}
  .back-btn:hover {transform: translateX(-3px);}
  
  /* Chat Screen */
  .chat-container {background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; height: calc(100vh - 200px); max-height: 700px;}
  
  .chat-header {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;}
  .chat-header h3 {font-size: 1.2em;}
  .chat-actions {display: flex; gap: 10px;}
  .chat-action-btn {background: rgba(255,255,255,0.2); border: none; border-radius: 8px; padding: 8px 12px; color: white; cursor: pointer; font-size: 1.2em; transition: all 0.2s;}
  .chat-action-btn:hover {background: rgba(255,255,255,0.3); transform: scale(1.1);}
  
  .chat-messages {flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column;}
  .chat-message {margin-bottom: 15px; display: flex; flex-direction: column; max-width: 75%; animation: slideIn 0.3s;}
  .chat-message.sent {align-self: flex-end; align-items: flex-end;}
  .chat-message.received {align-self: flex-start;}
  .message-bubble {padding: 12px 16px; border-radius: 18px; line-height: 1.5; word-wrap: break-word;}
  .chat-message.sent .message-bubble {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px;}
  .chat-message.received .message-bubble {background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-bottom-left-radius: 4px;}
  .message-time {font-size: 0.75em; opacity: 0.7; margin-top: 4px;}
  .message-image {max-width: 200px; border-radius: 12px; margin-top: 8px; cursor: pointer;}
  
  @keyframes slideIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
  }
  
  .chat-input-area {padding: 15px; background: white; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; align-items: center;}
  .attachment-btn {background: #f0f0f0; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.3em; transition: all 0.2s; flex-shrink: 0;}
  .attachment-btn:hover {background: #e0e0e0; transform: rotate(20deg);}
  .chat-input {flex: 1; padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 25px; font-size: 1em; font-family: inherit;}
  .chat-input:focus {outline: none; border-color: #667eea;}
  .send-btn {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.3em; transition: all 0.2s; flex-shrink: 0; display: flex; align-items: center; justify-content: center;}
  .send-btn:hover {transform: scale(1.1);}
  .send-btn:active {transform: scale(0.95);}
  
  /* Tasks Screen */
  .tasks-container {background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: calc(100vh - 200px); overflow-y: auto;}
  .tasks-header {margin-bottom: 25px;}
  .tasks-header h3 {font-size: 1.5em; color: #333; margin-bottom: 10px;}
  .tasks-stats {display: flex; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px;}
  .stat-item {flex: 1; text-align: center;}
  .stat-value {font-size: 1.8em; font-weight: bold; color: #667eea;}
  .stat-label {font-size: 0.85em; color: #666; margin-top: 4px;}
  
  .task-list {margin-top: 20px;}
  .task-item {background: white; border: 2px solid #e0e0e0; border-radius: 15px; padding: 18px; margin-bottom: 15px; transition: all 0.3s; cursor: pointer; position: relative;}
  .task-item:hover {transform: translateX(5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1);}
  .task-item.completed {opacity: 0.6; border-color: #4caf50;}
  .task-item.due-soon {border-color: #ff9800; background: #fff3e0;}
  .task-item.overdue {border-color: #ff4444; background: #ffebee;}
  
  .task-checkbox {position: absolute; top: 18px; right: 18px; width: 24px; height: 24px; border: 2px solid #667eea; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;}
  .task-item.completed .task-checkbox {background: #4caf50; border-color: #4caf50;}
  .task-checkbox::after {content: '‚úì'; color: white; font-weight: bold; opacity: 0;}
  .task-item.completed .task-checkbox::after {opacity: 1;}
  
  .task-content {padding-right: 40px;}
  .task-title {font-size: 1.1em; font-weight: 600; color: #333; margin-bottom: 8px;}
  .task-meta {display: flex; gap: 15px; font-size: 0.85em; color: #666; flex-wrap: wrap;}
  .task-meta span {display: flex; align-items: center; gap: 5px;}
  .task-badge {padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; margin-top: 8px; display: inline-block;}
  .badge-pending {background: #fff3e0; color: #f57c00;}
  .badge-due-soon {background: #ffebee; color: #c62828;}
  .badge-completed {background: #e8f5e9; color: #2e7d32;}
  
  /* Notification Badge */
  .notification-badge {position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; font-weight: bold; animation: pulse 2s infinite;}
  
  @keyframes pulse {
    0%, 100% {opacity: 1;}
    50% {opacity: 0.6;}
  }
  
  /* Modal */
  .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px;}
  .modal.active {display: flex;}
  .modal-content {background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s;}
  .modal-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
  .modal-header h3 {font-size: 1.4em; color: #333;}
  .close-modal {background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; width: 35px; height: 35px;}
  .close-modal:hover {color: #333;}
  .modal-body {line-height: 1.6;}
  .modal-video {width: 100%; border-radius: 12px; margin: 15px 0;}
  .modal-footer {margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;}
  .modal-btn {padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.2s;}
  .modal-btn-primary {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;}
  .modal-btn-primary:hover {transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4);}
  .modal-btn-secondary {background: #f0f0f0; color: #333;}
  .modal-btn-secondary:hover {background: #e0e0e0;}
  
  @keyframes modalSlide {
    from {transform: translateY(-30px); opacity: 0;}
    to {transform: translateY(0); opacity: 1;}
  }
  
  /* Category Selection */
  .category-selection {display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;}
  .category-btn {padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95em; transition: all 0.2s;}
  .category-btn:hover {border-color: #667eea; background: #f8f9ff;}
  .category-btn.selected {border-color: #667eea; background: #f8f9ff; font-weight: 600;}
  
  /* Push Notification */
  .push-notification {position: fixed; top: 80px; right: 20px; background: white; border-radius: 15px; padding: 15px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); min-width: 300px; z-index: 2000; animation: slideInRight 0.5s; display: none;}
  .push-notification.show {display: block;}
  .notification-header {display: flex; align-items: center; gap: 10px; margin-bottom: 8px;}
  .notification-icon {font-size: 1.5em;}
  .notification-title {font-weight: 600; color: #333;}
  .notification-body {color: #666; font-size: 0.9em;}
  .notification-time {font-size: 0.75em; color: #999; margin-top: 8px;}
  
  @keyframes slideInRight {
    from {transform: translateX(400px); opacity: 0;}
    to {transform: translateX(0); opacity: 1;}
  }
  
  /* Responsive */
  @media (max-width: 600px) {
    .main-buttons {grid-template-columns: 1fr; gap: 15px;}
    .container {padding: 15px;}
    .push-notification {right: 10px; min-width: calc(100% - 20px);}
  }
</style>
</head>
<body>

<!-- Header -->
<div class="app-header">
  <h1>üè• NetNurse</h1>
  <div class="user-info">
    <div class="user-avatar">MM</div>
  </div>
</div>

<!-- Push Notification -->
<div class="push-notification" id="pushNotification">
  <div class="notification-header">
    <span class="notification-icon">‚è∞</span>
    <span class="notification-title">Erinnerung</span>
  </div>
  <div class="notification-body" id="notificationBody"></div>
  <div class="notification-time" id="notificationTime"></div>
</div>

<div class="container">
  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="welcome-screen">
    <h2>Willkommen, Maria! üëã</h2>
    <p>Ihre Pflegekraft ist f√ºr Sie da</p>
    
    <div class="main-buttons">
      <button class="main-btn" onclick="showScreen('chat')">
        <div class="main-btn-icon">üí¨</div>
        <div class="main-btn-text">Verbinden</div>
        <div class="main-btn-desc">Chat mit Pflegekraft</div>
      </button>
      
      <button class="main-btn" onclick="showScreen('tasks')">
        <div class="main-btn-icon">‚úÖ</div>
        <div class="main-btn-text">Zuhause</div>
        <div class="main-btn-desc">Meine Aufgaben</div>
        <span class="notification-badge" id="taskNotificationBadge" style="display: none;">3</span>
      </button>
    </div>
  </div>

  <!-- Chat Screen -->
  <div id="chatScreen" class="content-screen">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê Zur√ºck</button>
    
    <div class="chat-container">
      <div class="chat-header">
        <div>
          <h3>A. Pausa</h3>
          <small style="opacity: 0.8;">üü¢ Online</small>
        </div>
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="startCall('phone')" title="Anrufen">üìû</button>
          <button class="chat-action-btn" onclick="startCall('video')" title="Videoanruf">üìπ</button>
        </div>
      </div>
      
      <div class="chat-messages" id="chatMessages"></div>
      
      <div class="chat-input-area">
        <button class="attachment-btn" onclick="showAttachmentModal()">üìé</button>
        <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht eingeben...">
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- Tasks Screen -->
  <div id="tasksScreen" class="content-screen">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê Zur√ºck</button>
    
    <div class="tasks-container">
      <div class="tasks-header">
        <h3>Meine Aufgaben</h3>
        <div class="tasks-stats">
          <div class="stat-item">
            <div class="stat-value" id="completedCount">0</div>
            <div class="stat-label">Erledigt</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="pendingCount">0</div>
            <div class="stat-label">Offen</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="complianceRate">0%</div>
            <div class="stat-label">Compliance</div>
          </div>
        </div>
      </div>
      
      <div class="task-list" id="taskList"></div>
    </div>
  </div>
</div>

<!-- Attachment Modal -->
<div class="modal" id="attachmentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üìé Datei senden</h3>
      <button class="close-modal" onclick="closeModal('attachmentModal')">√ó</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 15px; color: #666;">W√§hlen Sie eine Kategorie:</p>
      <div class="category-selection">
        <button class="category-btn" onclick="selectCategory(this, 'wound')">
          <span>ü©π</span> Wunde
        </button>
        <button class="category-btn" onclick="selectCategory(this, 'medication')">
          <span>üíä</span> Medikamente
        </button>
        <button class="category-btn" onclick="selectCategory(this, 'document')">
          <span>üìÑ</span> Dokumente
        </button>
        <button class="category-btn" onclick="selectCategory(this, 'general')">
          <span>üí¨</span> Allgemein
        </button>
      </div>
      <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf" onchange="handleFileSelected()">
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal('attachmentModal')">Abbrechen</button>
      <button class="modal-btn modal-btn-primary" onclick="document.getElementById('fileInput').click()">Datei ausw√§hlen</button>
    </div>
  </div>
</div>

<!-- Call Modal -->
<div class="modal" id="callModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="callTitle">üìû Anruf</h3>
      <button class="close-modal" onclick="closeModal('callModal')">√ó</button>
    </div>
    <div class="modal-body" id="callBody">
      <div style="text-align: center; padding: 40px 0;">
        <div style="font-size: 4em; margin-bottom: 20px;">‚òéÔ∏è</div>
        <p style="font-size: 1.2em; margin-bottom: 10px;">Verbindung wird hergestellt...</p>
        <p style="color: #999;">A. Pausa</p>
      </div>
      <video id="callVideo" class="modal-video" autoplay muted loop style="display: none;">
        <source src="https://video-previews.elements.envatousercontent.com/4eec503b-c193-4b4d-821a-cb232bcebdfc/watermarked_preview/watermarked_preview.mp4" type="video/mp4">
      </video>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="endCall()">Beenden</button>
    </div>
  </div>
</div>

<script>
// Patient Data
const patientData = {
  id: 'P001',
  name: 'Maria M√ºller',
  avatar: 'MM',
  nurse: {
    name: 'A. Pausa',
    online: true
  },
  messages: [
    {sender: 'nurse', text: 'Guten Tag Frau M√ºller! Wie geht es Ihnen heute?', time: '2025-10-17T08:00:00'},
    {sender: 'patient', text: 'Danke, mir geht es gut. Ich habe meine Medikamente genommen.', time: '2025-10-17T08:15:00'},
    {sender: 'nurse', text: 'Das freut mich zu h√∂ren. Bitte denken Sie auch an das Trinkprotokoll.', time: '2025-10-17T08:20:00'}
  ],
  tasks: [
    {id: 1, title: 'Medikamente einnehmen', description: 'Morgenmedikation: 1x Ramipril 5mg', type: 'medication', due: '2025-10-17T08:00:00', completed: true, icon: 'üíä'},
    {id: 2, title: 'Trinkprotokoll f√ºhren', description: 'Mindestens 1500ml Fl√ºssigkeit dokumentieren', type: 'monitoring', due: '2025-10-17T12:00:00', completed: true, icon: 'üíß'},
    {id: 3, title: 'K√∂rpergewicht messen', description: 'Gewicht auf n√ºchternen Magen messen', type: 'measurement', due: '2025-10-17T18:00:00', completed: false, icon: '‚öñÔ∏è'},
    {id: 4, title: 'Befinden-Fragebogen', description: 'Kurze Umfrage zu Ihrem Wohlbefinden', type: 'survey', due: '2025-10-18T09:00:00', completed: false, icon: 'üìù'},
    {id: 5, title: 'Medikamente einnehmen', description: 'Abendmedikation: 1x Ramipril 5mg', type: 'medication', due: '2025-10-17T20:00:00', completed: false, icon: 'üíä'}
  ]
};

let selectedCategory = 'general';
let currentScreen = 'welcome';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  console.log('App initialisiert');
  loadFromStorage();
  updateTaskBadge();
  checkDueTasks();
  setInterval(checkDueTasks, 60000);
});

// Screen Navigation
function showScreen(screen) {
  console.log('Wechsle zu Screen:', screen);
  
  // Hide all screens
  document.getElementById('welcomeScreen').style.display = 'none';
  document.getElementById('chatScreen').classList.remove('active');
  document.getElementById('tasksScreen').classList.remove('active');
  
  currentScreen = screen;
  
  if (screen === 'welcome') {
    document.getElementById('welcomeScreen').style.display = 'block';
  } else if (screen === 'chat') {
    document.getElementById('chatScreen').classList.add('active');
    renderMessages();
  } else if (screen === 'tasks') {
    document.getElementById('tasksScreen').classList.add('active');
    renderTasks();
  }
}

// Chat Functions
function renderMessages() {
  const container = document.getElementById('chatMessages');
  container.innerHTML = '';
  
  patientData.messages.forEach(function(msg) {
    const div = document.createElement('div');
    div.className = 'chat-message ' + (msg.sender === 'patient' ? 'sent' : 'received');
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = msg.text;
    
    if (msg.image) {
      const img = document.createElement('img');
      img.src = msg.image;
      img.className = 'message-image';
      bubble.appendChild(img);
    }
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = formatTime(msg.time);
    
    div.appendChild(bubble);
    div.appendChild(time);
    container.appendChild(div);
  });
  
  container.scrollTop = container.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  
  const message = {
    sender: 'patient',
    text: text,
    time: new Date().toISOString()
  };
  
  patientData.messages.push(message);
  saveToStorage();
  renderMessages();
  input.value = '';
  
  // Simulate nurse response
  setTimeout(function() {
    const response = {
      sender: 'nurse',
      text: 'Vielen Dank f√ºr Ihre Nachricht. Ich habe Ihre Information erhalten.',
      time: new Date().toISOString()
    };
    patientData.messages.push(response);
    saveToStorage();
    renderMessages();
  }, 2000);
}

// Enter key to send
setTimeout(function() {
  const input = document.getElementById('chatInput');
  if (input) {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  }
}, 100);

// Attachment Functions
function showAttachmentModal() {
  document.getElementById('attachmentModal').classList.add('active');
}

function selectCategory(btn, category) {
  const buttons = document.querySelectorAll('.category-btn');
  buttons.forEach(function(b) {
    b.classList.remove('selected');
  });
  btn.classList.add('selected');
  selectedCategory = category;
}

function handleFileSelected() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return;
  
  const categoryIcons = {
    wound: 'ü©π',
    medication: 'üíä',
    document: 'üìÑ',
    general: 'üí¨'
  };
  
  const message = {
    sender: 'patient',
    text: categoryIcons[selectedCategory] + ' Datei gesendet: ' + file.name,
    time: new Date().toISOString(),
    category: selectedCategory,
    image: file.type.startsWith('image/') ? URL.createObjectURL(file) : null
  };
  
  patientData.messages.push(message);
  saveToStorage();
  renderMessages();
  closeModal('attachmentModal');
  
  document.getElementById('fileInput').value = '';
  selectedCategory = 'general';
}

// Tasks Functions
function renderTasks() {
  const container = document.getElementById('taskList');
  container.innerHTML = '';
  
  const now = new Date();
  let completed = 0;
  let pending = 0;
  
  patientData.tasks.forEach(function(task) {
    const dueDate = new Date(task.due);
    const hoursDiff = (dueDate - now) / 3600000;
    
    if (task.completed) {
      completed++;
    } else {
      pending++;
    }
    
    const isOverdue = dueDate < now && !task.completed;
    const isDueSoon = hoursDiff < 2 && hoursDiff > 0 && !task.completed;
    
    const div = document.createElement('div');
    div.className = 'task-item';
    if (task.completed) div.classList.add('completed');
    else if (isOverdue) div.classList.add('overdue');
    else if (isDueSoon) div.classList.add('due-soon');
    
    const badgeClass = task.completed ? 'badge-completed' : 
                       isOverdue ? 'badge-due-soon' : 'badge-pending';
    const badgeText = task.completed ? '‚úì Erledigt' : 
                     isOverdue ? '‚ö† √úberf√§llig' : 
                     isDueSoon ? '‚è∞ Bald f√§llig' : '‚è≥ Geplant';
    
    div.innerHTML = '<div class="task-checkbox"></div>' +
      '<div class="task-content">' +
        '<div class="task-title">' + task.icon + ' ' + task.title + '</div>' +
        '<div class="task-meta">' +
          '<span>üïí ' + formatDateTime(task.due) + '</span>' +
        '</div>' +
        '<div style="margin-top: 8px; color: #666; font-size: 0.9em;">' + task.description + '</div>' +
        '<span class="task-badge ' + badgeClass + '">' + badgeText + '</span>' +
      '</div>';
    
    div.onclick = function() {
      toggleTask(task.id);
    };
    container.appendChild(div);
  });
  
  // Update stats
  document.getElementById('completedCount').textContent = completed;
  document.getElementById('pendingCount').textContent = pending;
  const compliance = patientData.tasks.length > 0 ? 
    Math.round((completed / patientData.tasks.length) * 100) : 0;
  document.getElementById('complianceRate').textContent = compliance + '%';
  
  updateTaskBadge();
}

function toggleTask(taskId) {
  const task = patientData.tasks.find(function(t) {
    return t.id === taskId;
  });
  if (!task) return;
  
  task.completed = !task.completed;
  saveToStorage();
  renderTasks();
  
  if (task.completed) {
    showNotification('Aufgabe erledigt!', '"' + task.title + '" wurde als erledigt markiert.');
  }
}

function updateTaskBadge() {
  const pendingTasks = patientData.tasks.filter(function(t) {
    return !t.completed;
  }).length;
  const badge = document.getElementById('taskNotificationBadge');
  if (pendingTasks > 0) {
    badge.textContent = pendingTasks;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

// Check for due tasks and send notifications
function checkDueTasks() {
  const now = new Date();
  
  patientData.tasks.forEach(function(task) {
    if (task.completed) return;
    
    const dueDate = new Date(task.due);
    const minutesDiff = (dueDate - now) / 60000;
    
    // Notify 15 minutes before due
    if (minutesDiff > 14 && minutesDiff < 16) {
      showNotification(
        'Aufgabe bald f√§llig!',
        '"' + task.title + '" ist in 15 Minuten f√§llig.'
      );
    }
    
    // Notify when overdue
    if (minutesDiff < 0 && minutesDiff > -2) {
      showNotification(
        'Aufgabe √ºberf√§llig!',
        '"' + task.title + '" ist jetzt √ºberf√§llig.'
      );
    }
  });
}

// Push Notification
function showNotification(title, body) {
  const notification = document.getElementById('pushNotification');
  const notificationBody = document.getElementById('notificationBody');
  const notificationTime = document.getElementById('notificationTime');
  
  notificationBody.textContent = body;
  notificationTime.textContent = formatTime(new Date().toISOString());
  notification.classList.add('show');
  
  setTimeout(function() {
    notification.classList.remove('show');
  }, 5000);
}

// Call Functions
function startCall(type) {
  const modal = document.getElementById('callModal');
  const title = document.getElementById('callTitle');
  const video = document.getElementById('callVideo');
  
  if (type === 'video') {
    title.textContent = 'üìπ Videoanruf';
    video.style.display = 'block';
  } else {
    title.textContent = 'üìû Telefonanruf';
    video.style.display = 'none';
  }
  
  modal.classList.add('active');
}

function endCall() {
  closeModal('callModal');
}

// Modal Functions
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// Helper Functions
function formatTime(dateString) {
  const date = new Date(dateString);
  return date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
}

function formatDateTime(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString('de-DE', {
    day: '2-digit',
    month: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Storage
function saveToStorage() {
  try {
    localStorage.setItem('netnurse_patient_data', JSON.stringify(patientData));
  } catch (e) {
    console.warn('LocalStorage nicht verf√ºgbar');
  }
}

function loadFromStorage() {
  try {
    const stored = localStorage.getItem('netnurse_patient_data');
    if (stored) {
      const loaded = JSON.parse(stored);
      Object.assign(patientData, loaded);
    }
  } catch (e) {
    console.warn('Fehler beim Laden');
  }
}

// Close modals with ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal.active');
    modals.forEach(function(modal) {
      closeModal(modal.id);
    });
  }
});

// Close modals on background click
document.querySelectorAll('.modal').forEach(function(modal) {
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal(modal.id);
    }
  });
});
</script>

</body>
</html>